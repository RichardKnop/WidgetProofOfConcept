<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Widget Proof Of Concept</title>
        <link rel="stylesheet" href="/qunit.css">
        <script src="/qunit.js"></script>
    </head>
    <body>
        <div id="qunit"></div>
        <div id="qunit-fixture"></div>
        <script type="text/javascript">//<![CDATA[
            (function(w) {
                //------------------------------------
                // Widget Manager
                //------------------------------------
                function WidgetManager(placementId) {
                    this.placementId = placementId;
                    var adapterFactory = new AdapterFactory();
                    this.playerManager = new PlayerManager(adapterFactory.manufacture());
                }
                WidgetManager.prototype.loadConfig = function() {
                    console.log("load config based on " + this.placementId);
                    return this;
                }
                WidgetManager.prototype.loadModules = function(modules) {
                    console.log("loading modules " + modules.join(", "));
                    this.modules = modules;
                    return this;
                }
                WidgetManager.prototype.loadVideo = function(id) {
                    this.playerManager.adapter.loadVideo(id);
                    return this;
                }

                //------------------------------------
                // Player Manager
                //------------------------------------
                function PlayerManager(adapter) {
                    this.adapter = adapter;
                }

                // Abstract adapter class
                function PlayerAdapter(config) {
                    this.config = config;
                }
                PlayerAdapter.prototype.loadVideo = function(id) {
                    console.log("loading video " + id);
                    return id;
                }

                // HTML5 adapter
                function HTML5Adapter(config) {
                    // call parent constructor
                    PlayerAdapter.call(this, config);
                }
                // inherit all parent methods
                HTML5Adapter.prototype = new PlayerAdapter();

                // Flash adapter
                function FlashAdapter(config) {
                    // call parent constructor
                    PlayerAdapter.call(this, config);
                }
                // inherit all parent methods
                FlashAdapter.prototype = new PlayerAdapter();

                // Adapter factory, will contain some logic to choose correct
                // adapter based on device, browser etc
                function AdapterFactory() {
                }
                AdapterFactory.prototype.manufacture = function() {
                    // some logic here
                    return new FlashAdapter({"foo": "bar"});
                }

                //------------------------------------
                // Assign objects we want visible outside current scope
                //------------------------------------
                w.WidgetManager = WidgetManager;
                w.PlayerManager = PlayerManager;
                w.AdapterFactory = AdapterFactory;
            })(window);
            
            runTests();
            
            // Functions
            function runTests() {
                test("Test WidgetManager constructor", function() {
                    var widgetManager = new WidgetManager("somePlacementId");
                    strictEqual(widgetManager.placementId, "somePlacementId");
                });
                test("Test WidgetManager::loadModules", function() {
                    var widgetManager = new WidgetManager("somePlacementId");
                    widgetManager.loadModules(["a", "b", "c"]);
                    equal(widgetManager.modules.length, 3);
                    deepEqual(widgetManager.modules, ["a", "b", "c"]);
                });
                test("Test WidgetManager method chaining", function() {
                    var widgetManager = new WidgetManager("somePlacementId");
                    ok(widgetManager.loadConfig().loadModules(["a", "b", "c"]).loadVideo("foo") instanceof WidgetManager);
                });
            }
            //]]></script>
    </body>
</html>